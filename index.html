<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇宙考古 | 集体主义的协奏曲 v83.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 挂载核心功能
        window.firebaseCore = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDocs, collection, query, onSnapshot, deleteDoc };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=JetBrains+Mono:wght@300;500&display=swap');

        :root {
            --bg-white: #ffffff;
            --text-main: #000000;
            --border-thin: 1px solid rgba(0,0,0,0.1);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-white);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            cursor: none; 
        }

        /* 运行环境警告 UI */
        #protocol-warning {
            position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
            background: #ff3e3e; color: #fff; font-size: 11px; text-align: center;
            z-index: 5000; display: none; font-family: 'JetBrains Mono';
        }

        /* 自定义光标 */
        #custom-cursor {
            position: fixed; width: 12px; height: 12px; border: 1px solid #000;
            border-radius: 50%; pointer-events: none; z-index: 9999;
            transition: transform 0.1s ease-out;
        }

        /* 调频界面 */
        .tuner-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 500; pointer-events: none;
        }
        .tuner-ring {
            width: 60px; height: 60px; border: 1px solid #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 0 100vw rgba(255,255,255,0.3);
        }
        .signal-meter {
            position: absolute; bottom: -40px; width: 80px; height: 2px;
            background: rgba(0,0,0,0.05); overflow: hidden;
        }
        #signal-bar { width: 0%; height: 100%; background: #000; transition: width 0.3s; }

        .site-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 50px; border-bottom: var(--border-thin);
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); z-index: 1000;
        }
        .site-title { font-weight: 900; letter-spacing: -0.05em; font-size: 1.2rem; text-transform: uppercase; }

        .sidebar {
            position: fixed; top: 70px; left: 0; width: 320px; height: calc(100vh - 70px);
            border-right: var(--border-thin); padding: 50px;
            background: #fff; z-index: 900;
        }
        .sidebar-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: #aaa; margin-bottom: 12px; display: block; }
        .sidebar-value { font-family: 'JetBrains Mono'; font-size: 11px; margin-bottom: 35px; }

        #stage { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        #artifact-card {
            position: absolute; bottom: 50px; right: 50px; width: 460px; z-index: 950;
            background: #fff; border: 1.5px solid #000;
            padding: 40px; display: none;
            box-shadow: 40px 40px 80px rgba(0,0,0,0.08);
        }
        .entry-title { font-size: 2rem; font-weight: 900; letter-spacing: -0.05em; line-height: 1; margin-bottom: 20px; }
        .entry-img-wrap { background: #fafafa; border: 1px solid #eee; margin-bottom: 25px; overflow: hidden; position: relative; }
        .entry-img { width: 100%; height: auto; opacity: 0; transition: opacity 1s; filter: contrast(1.1); }
        .entry-body { font-size: 14px; line-height: 1.8; color: #333; max-height: 150px; overflow-y: auto; }

        #visualizer { display: flex; gap: 3px; align-items: flex-end; height: 30px; }
        .v-bar { width: 3px; background: #000; opacity: 0.8; }

        #audio-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #000;
        }
        .btn-launch {
            padding: 20px 60px; border: 1.5px solid #000; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.3em; font-size: 0.75rem; transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            cursor: pointer;
        }
        .btn-launch:hover { background: #000; color: #fff; letter-spacing: 0.5em; transform: scale(1.05); }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #000; }
    </style>
</head>
<body>

    <div id="protocol-warning">检测到本地运行：请使用本地服务器（如 VS Code Live Server）打开此文件，否则 3D 组件将无法加载。</div>
    <div id="custom-cursor"></div>
    
    <div class="tuner-container">
        <div class="tuner-ring">
            <div id="tuner-inner" class="w-1 h-1 bg-black rounded-full"></div>
        </div>
        <div class="signal-meter">
            <div id="signal-bar"></div>
        </div>
    </div>

    <header class="site-header">
        <div class="site-title">Cosmic Archaeology / 宇宙考古</div>
        <div class="font-mono text-[9px] opacity-40">CHRONOS_VER v83.1 // STABLE_READY</div>
    </header>

    <aside class="sidebar">
        <div>
            <span class="sidebar-label">Archive Status</span>
            <div class="sidebar-value font-bold text-lg">集体主义的协奏曲</div>
            
            <span class="sidebar-label">Synthesis Rhythm</span>
            <div class="sidebar-value">124 BPM // High Fidelity</div>
            <div id="visualizer"></div>

            <span class="sidebar-label">Indexed Count</span>
            <div class="sidebar-value"><span id="node-ptr">0</span> / 100 节点</div>

            <span class="sidebar-label">Connection Status</span>
            <div id="ai-status-display" class="sidebar-value italic text-gray-300">终端就绪...</div>
        </div>
        <div class="mt-auto pt-10">
            <button onclick="window.clearLocalVault()" class="text-[9px] uppercase tracking-widest opacity-20 hover:opacity-100 hover:text-red-600 transition-all">Reset Cache</button>
        </div>
    </aside>

    <div id="stage"></div>

    <div id="artifact-card">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <div class="w-1.5 h-1.5 bg-black rounded-full mr-2"></div>
                <span class="text-[9px] font-bold tracking-widest uppercase opacity-40">Signal Verified</span>
            </div>
            <span class="text-[9px] font-mono opacity-20" id="card-uid">0x00</span>
        </div>
        <h2 class="entry-title" id="card-title">Scanning...</h2>
        <div class="entry-img-wrap aspect-[16/10] flex items-center justify-center">
            <img id="card-img" src="" class="entry-img grayscale">
            <div id="img-loader" class="w-8 h-8 border border-black border-t-transparent rounded-full animate-spin"></div>
        </div>
        <div class="entry-body" id="card-content">正在解密历史无线电信号...</div>
        <div id="card-sources" class="mt-8 pt-6 border-t border-gray-100 flex flex-wrap gap-x-4 gap-y-2"></div>
    </div>

    <div id="audio-overlay" onclick="window.unlockAudio()">
        <div class="mb-10 text-[10px] tracking-[1.2em] uppercase opacity-20">The Archaeology of Collective Will</div>
        <h1 class="text-8xl font-black mb-16 tracking-tighter">CONCERTO.</h1>
        <div class="btn-launch">Execute Data Sync</div>
    </div>

    <script type="module">
        if (window.location.protocol === 'file:') {
            document.getElementById('protocol-warning').style.display = 'block';
        }

        const apiKey = "";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-can-v83-stable';
        const firebaseConfig = JSON.parse(__firebase_config);
        
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, getDocs, collection, query, onSnapshot, signInWithCustomToken, deleteDoc } = window.firebaseCore;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let scene, camera, renderer, starField, clusterGroup, lineGroup, clock = new THREE.Clock();
        let stands = [], isCruiseActive = true, isEngineRunning = false, bpm = 124, user = null;
        let currentNodeIndex = -1, intervalId = null;
        let audioCtx, analyser, dataArray, nextNoteTime = 0, currentStep = 0;
        let camTarget = new THREE.Vector3(0, 0, 0);

        const itemPool = ["1970年人民日报", "万吨水压机", "东方红一号", "飞鸽自行车", "劳动模范奖章", "红灯收音机", "解放牌汽车", "原子弹公报", "蝴蝶缝纫机", "英雄钢笔", "大庆日记", "援藏纪念章", "上海牌手表", "丰收大铁锅", "工农兵画报"];

        const heritagePoints = Array.from({length: 100}, (_, i) => ({
            name: itemPool[i % itemPool.length],
            id: `node_${i}`
        }));

        async function compressBase64(base64Str) {
            return new Promise((resolve) => {
                const img = new Image(); img.crossOrigin = "anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = 800, h = (w / img.width) * img.height;
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = base64Str;
            });
        }

        async function fetchVisualRestore(queryStr) {
            const prompt = `Realistic RAW documentary BLACK AND WHITE photography scan of ${queryStr}, vintage film texture, sharp historical text focus, isolated on white background.`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
            try {
                const r = await fetch(url, { method: 'POST', body: JSON.stringify({ instances: { prompt }, parameters: { sampleCount: 1 } }) });
                const res = await r.json();
                return res.predictions?.[0]?.bytesBase64Encoded ? `data:image/png;base64,${res.predictions[0].bytesBase64Encoded}` : null;
            } catch (err) { return null; }
        }

        async function fetchSearchData(queryStr) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const r = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: `实时检索 1950s-70s 中国的历史资料，为物件“${queryStr}”提供一个精准的学术历史定义，并给出 2 个来源链接。` }] }], tools: [{ "google_search": {} }] }) });
                const res = await r.json();
                const text = res.candidates?.[0]?.content?.parts?.[0]?.text || "检索失败：请检查网络。";
                const sources = res.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map(a => ({ uri: a.web?.uri, title: a.web?.title })) || [];
                return { text, sources };
            } catch (err) { return { text: "Search Error", sources: [] }; }
        }

        function audioLoop() {
            if (!isEngineRunning) return;
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                const s = currentStep % 16;
                if (s % 4 === 0) playKick(nextNoteTime); 
                if (s % 8 === 0) playBass(nextNoteTime, 55);
                nextNoteTime += (60 / bpm) / 4;
                currentStep++;
            }
            requestAnimationFrame(audioLoop);
        }
        function playKick(t) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.frequency.setValueAtTime(130, t); o.frequency.exponentialRampToValueAtTime(0.01, t + 0.5); g.gain.setValueAtTime(0.4, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.5); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 0.5); }
        function playBass(t, f) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'sine'; o.frequency.setValueAtTime(f, t); g.gain.setValueAtTime(0.08, t); g.gain.exponentialRampToValueAtTime(0.001, t + 1.2); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t + 1.2); }

        window.unlockAudio = async function() {
            setupScene(); await initAuth();
            onAuthStateChanged(auth, (u) => { user = u; if (user) loadVault(); });
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser(); analyser.fftSize = 64; 
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.connect(audioCtx.destination);
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                document.getElementById('audio-overlay').style.display = 'none';
                isEngineRunning = true; nextNoteTime = audioCtx.currentTime;
                createVisualizer(); audioLoop();
                intervalId = setInterval(excavateNext, 16000); excavateNext();
            } catch (err) {}
        };

        window.clearLocalVault = async function() { if(confirm("重置考古数据？")) { const snap = await getDocs(collection(db, 'artifacts', appId, 'users', user.uid, 'archives')); snap.forEach(async (d) => await deleteDoc(d.ref)); location.reload(); } };

        async function initAuth() { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); }

        function setupScene() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff);
            scene.fog = new THREE.Fog(0xffffff, 100, 250);
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(40, aspect, 0.1, 2000);
            camera.position.set(0, 0, 150);
            renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); document.getElementById('stage').appendChild(renderer.domElement);

            clusterGroup = new THREE.Group(); scene.add(clusterGroup);
            lineGroup = new THREE.Group(); clusterGroup.add(lineGroup);

            const pCount = 3500;
            const pGeo = new THREE.BufferGeometry(); const pPos = new Float32Array(pCount * 3);
            for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random() - 0.5) * 1200;
            pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
            starField = new THREE.Points(pGeo, new THREE.PointsMaterial({ color: 0x000000, size: 0.7, transparent: true, opacity: 0.15 }));
            scene.add(starField);

            const radius = 85;
            heritagePoints.forEach((pt, i) => {
                const y = 1 - (i / (100 - 1)) * 2;
                const rAtY = Math.sqrt(1 - y * y);
                const phi = 2.3999632 * i;
                const x = Math.cos(phi) * rAtY; const z = Math.sin(phi) * rAtY;
                const cardGeo = new THREE.PlaneGeometry(8.5, 12);
                const card = new THREE.Mesh(cardGeo, new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.2, side: THREE.DoubleSide }));
                card.position.set(x * radius, y * radius, z * radius);
                card.lookAt(0, 0, 0);
                clusterGroup.add(card);
                stands.push({ ...pt, mesh: card, pos: card.position.clone(), textureLoaded: false });
            });

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 0.4); sun.position.set(50, 50, 50); scene.add(sun);
            animate();
        }

        async function excavateNext() {
            if (!isEngineRunning || !isCruiseActive) return;
            currentNodeIndex++;
            if (currentNodeIndex >= stands.length) { showFinal(); return; }
            const target = stands[currentNodeIndex];

            updateUI('ai-status-display', `Tuning Signal... [${target.name}]`);
            gsap.to('#signal-bar', { width: "100%", duration: 3.5, ease: "power1.inOut" });

            const targetPos = target.pos.clone();
            const quaternion = new THREE.Quaternion().setFromUnitVectors(targetPos.clone().normalize(), new THREE.Vector3(0, 0, 1));
            gsap.to(clusterGroup.quaternion, { x: quaternion.x, y: quaternion.y, z: quaternion.z, w: quaternion.w, duration: 4.5, ease: "expo.inOut" });

            const [sData, b64] = target.textureLoaded ? [target.searchData, target.cachedB64] : await Promise.all([fetchSearchData(target.name), fetchVisualRestore(target.name)]);

            if (b64) {
                target.cachedB64 = b64; target.searchData = sData;
                const imgEl = document.getElementById('card-img');
                imgEl.onload = () => { 
                    imgEl.style.opacity = "1"; 
                    document.getElementById('img-loader').style.display = 'none'; 
                    gsap.to('#signal-bar', { width: "0%", duration: 0.5 });
                };
                imgEl.src = b64;
                new THREE.TextureLoader().load(b64, (tex) => {
                    target.mesh.material.map = tex; target.mesh.material.opacity = 1; target.mesh.material.needsUpdate = true;
                    if(!target.textureLoaded) saveToVault(currentNodeIndex, b64, sData);
                    target.textureLoaded = true;
                });
                
                updateUI('card-title', target.name); updateUI('card-content', sData.text);
                updateUI('card-uid', `NODE_0x${currentNodeIndex.toString(16).toUpperCase()}`);
                const sCont = document.getElementById('card-sources'); sCont.innerHTML = '';
                sData.sources.slice(0, 2).forEach(s => {
                    const a = document.createElement('a'); a.href = s.uri; a.target = '_blank'; a.className = 'text-[9px] font-mono underline opacity-40 hover:opacity-100 mb-2 block'; a.innerText = `LINK: ${s.title.substring(0, 30)}...`;
                    sCont.appendChild(a);
                });
                const card = document.getElementById('artifact-card'); card.style.display = 'block';
                gsap.fromTo(card, { opacity: 0, x: 40 }, { opacity: 1, x: 0, duration: 1.2, ease: "expo.out" });
            }
            updateUI('node-ptr', currentNodeIndex + 1);
        }

        function showFinal() {
            isCruiseActive = false; clearInterval(intervalId);
            document.getElementById('artifact-card').style.display = 'none';
            gsap.to(camera.position, { z: 280, duration: 8, ease: "expo.inOut" });
        }

        async function saveToVault(idx, b64, data) { if(!user) return; const cB64 = await compressBase64(b64); await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'archives', `node_${idx}`), { name: stands[idx].name, image: cB64, data: JSON.stringify(data), timestamp: Date.now() }); }
        async function loadVault() {
            if(!user) return;
            const snap = await getDocs(collection(db, 'artifacts', appId, 'users', user.uid, 'archives'));
            snap.forEach(ds => {
                const d = ds.data(); const idx = parseInt(ds.id.split('_')[1]);
                if(stands[idx]) {
                    stands[idx].cachedB64 = d.image; stands[idx].searchData = JSON.parse(d.data);
                    new THREE.TextureLoader().load(d.image, (tex) => { stands[idx].mesh.material.map = tex; stands[idx].mesh.material.opacity = 1; stands[idx].textureLoaded = true; });
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(starField) starField.rotation.y += 0.0003;
            renderer.render(scene, camera);
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const bars = document.querySelectorAll('.v-bar');
                bars.forEach((b, i) => { if(b) b.style.height = (dataArray[i] / 4.5) + 'px'; });
            }
        }

        function updateUI(id, val) { const el = document.getElementById(id); if (el) el.innerHTML = val; }
        function createVisualizer() { const v = document.getElementById('visualizer'); if (v) { v.innerHTML = ''; for (let i = 0; i < 24; i++) { const b = document.createElement('div'); b.className = 'v-bar'; v.appendChild(b); } } }
        
        window.addEventListener('mousemove', (e) => {
            gsap.to('#custom-cursor', { x: e.clientX - 6, y: e.clientY - 6, duration: 0.1 });
        });

        window.addEventListener('resize', () => { 
            if (!camera || !renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });
    </script>
</body>
</html>